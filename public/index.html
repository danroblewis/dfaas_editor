<title>DFaaS</title>

<script src="codeflask.min.js"></script>

<style>
body { font-family: Arial; }
#function_code {
    background: #eee;
    margin-left: 150px;
}
.function_list_container {
    font-family: monospace;
    position: absolute;
    top: 0;
    left: 0;
    width: 100px;
}
.function_list_container #new_function {
    padding: 10px 10px 10px 75px;
}
.function_list_container #new_function:hover {
    content: '‚ìß';
}
#function_list {
    list-style: none;
    padding: 0;
}
#function_list li {
    padding: 5px 10px;
    margin: 0;
    width: 150px;
}
#function_list li:hover {
    background: #eeddee33;
    cursor: pointer;
}
#function_list li.active {
    background: #eeccee44;
}
#new_function {
    cursor: pointer;
}
#delete_function {
    margin: 15px 75px;
    cursor: pointer;
}
textarea.codeflask__textarea.changes {
    background: #f7fefe;
}
.codeflask {
    height: 88% !important;
}
#stdout {
    background: #3333;
    position: fixed;
    z-index: 1;
    width: 100%;
    padding: 5px;
    height: 100px;
    bottom: -30px;
    margin-left: -8px;
    overflow: scroll;
}
</style>


<div id="function_code"></div>

<div class="function_list_container">
  <div id="new_function">+</div>
  <div id="delete_function">üóëÔ∏è</div>
  <ul id="function_list"></ul>
</div>

<div class="stdout">
<pre id="stdout"></pre>
</div>


<script type='text/javascript'>
const flask = new CodeFlask('#function_code', {
  language: 'js',
  lineNumbers: true,
  handleTabs: true
});

function setChanged() {
    flask.elWrapper.getElementsByTagName('textarea')[0].classList.add('changes')
}
function setUnchanged() {
    flask.elWrapper.getElementsByTagName('textarea')[0].classList.remove('changes')
}

flask.onUpdate(setChanged)

window['flask'] = flask;

window.fname = ""
window.changed = false

function get(url, fn) {
    var x = new XMLHttpRequest();
    x.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            fn(JSON.parse(x.responseText))
        }
    }
    x.open('GET', url, true);
    x.send();
}
function post(url, json, fn) {
    var x = new XMLHttpRequest();
    x.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            fn && fn(JSON.stringify(x.responseText))
        }
    }
    x.open('POST', url, true);
    x.setRequestHeader('Content-Type', 'application/json');
    x.send(JSON.stringify(json));
}

function open_file(_fname) {
    window.fname = _fname;
    console.log(window.fname)
    get('/read/' + _fname, function(j) {
        flask.updateCode(j.code)
        setTimeout(setUnchanged, 100)
    })
}

function populate_function_list() {
    get('/function_list', function(names) {
        let ul = document.getElementById('function_list');
        let html = '';
        for (var name of names) {
            html += '<li ' + (name == window.fname ? 'class="active" ' : '') + '>' + name + '</li>';
        }
        ul.innerHTML = html;
        for (var li of ul.getElementsByTagName('li')) {
            li.onclick = (function(_fname) {
                return function() { open_file(_fname); populate_function_list(); }
            })(li.innerText)
        }
    })
}

function populate_stdout() {
    get('/stdout/' + window.fname, function(d) {
        var o = document.getElementById('stdout')
        var oo = ""
        for (var i=d['stdouts'].length-1; i>=0; i--) {
          oo += Math.floor(d['stdouts'][i]['tstamp']) + ' >> ' + d['stdouts'][i]['stdout'].trim().replaceAll("\n", "\n" + Math.floor(d['stdouts'][i]['tstamp']) + ' >> ') + "\n"
        }
        o.innerText = oo
    })
}

function intervolate(fn, ms) { var i=setInterval(fn, ms); fn(); console.log(i); return i;}

intervolate(populate_function_list, 2000)
intervolate(populate_stdout, 5000)

document.getElementById('new_function').onclick = function() {
    var new_fname = prompt("choose a dang filename")
    if (!new_fname) return
    window.fname = new_fname
    post('/create/' + window.fname)
    populate_function_list()
}

document.getElementById('delete_function').onclick = function() {
    var fname = prompt("!!! give the function name you want to delete !!!")
    if (!fname) return
    if (window.fname == fname) {
        window.fname = ''
    }
    open_file(window.fname)
    post('/delete/' + fname)
    populate_function_list()
}

document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        post('/write/' + window.fname, {'code':flask.getCode()})
        setUnchanged()
    }
});
</script>
