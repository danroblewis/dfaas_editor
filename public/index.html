<title>DFaaS</title>

<script src="codeflask.min.js"></script>

<style>
body { font-family: Arial; }
#function_code {
    background: #eee;
    margin-left: 150px;
}
.function_list_container {
    font-family: monospace;
    position: absolute;
    top: 0;
    left: 0;
    width: 100px;
}
.function_list_container #new_function:hover {
    content: '‚ìß';
}
#function_list {
    list-style: none;
    padding: 0;
}
#function_list li {
    padding: 5px 10px;
    margin: 0;
    width: 150px;
}
#function_list li:hover {
    background: #eeddee33;
    cursor: pointer;
}
#function_list li.active {
    background: #eeccee44;
}
#function_list li.broken:before {
    content: '‚ö†Ô∏è';
    margin-right: 3px;
}
#function_list li.process:before {
    content: 'üßä';
    margin-right: 3px;
}
#new_function {
    cursor: pointer;
}
#delete_function {
    cursor: pointer;
}
.function_list_container .actions {
    text-align: center;
    width: 150%;
    margin-top: 10px;
}
textarea.codeflask__textarea.changes {
    background: #f7fefe;
}
.codeflask {
    height: 88% !important;
}
#stdout {
    background: #3333;
    position: fixed;
    z-index: 1;
    width: 100%;
    padding: 5px;
    height: 100px;
    bottom: -30px;
    margin-left: -8px;
    overflow: scroll;
}
</style>


<div id="function_code"></div>

<div class="function_list_container">
  <div class="actions">
    <span id="new_function">‚ûï</span>
    <span id="delete_function">üóëÔ∏è</span>
    <span id="map"><a href="/fn_map?level=1" target="_fn_nmap">üó∫Ô∏è</a></span>
  </div>
  <ul id="function_list"></ul>
</div>

<div class="stdout">
<pre id="stdout"></pre>
</div>


<script type='text/javascript'>
const flask = new CodeFlask('#function_code', {
  language: 'js',
  lineNumbers: true,
  handleTabs: true
});

function setChanged() {
    flask.elWrapper.getElementsByTagName('textarea')[0].classList.add('changes')
}
function setUnchanged() {
    flask.elWrapper.getElementsByTagName('textarea')[0].classList.remove('changes')
}

flask.onUpdate(setChanged)

window['flask'] = flask;

window.fname = ""
window.process = false
window.changed = false

function get(url, fn) {
    var x = new XMLHttpRequest();
    x.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            fn(JSON.parse(x.responseText))
        }
    }
    x.open('GET', url, true);
    x.send();
}
function post(url, json, fn) {
    var x = new XMLHttpRequest();
    x.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            fn && fn(JSON.stringify(x.responseText))
        }
    }
    x.open('POST', url, true);
    x.setRequestHeader('Content-Type', 'application/json');
    x.send(JSON.stringify(json));
}

function getProperName(_fname) {
    var _procs = document.getElementById('function_list').getElementsByClassName('process')
    for (var proc of _procs) {
      if (_fname == proc.innerText) {
        return 'process:' + _fname;
      }
    }
    return _fname
}
console.log(getProperName('add_field'))
console.log(getProperName('weather'))

function open_file(_fname) {
    window.fname = getProperName(_fname);
    get('/read/' + _fname, function(j) {
        flask.updateCode(j.code)
        setTimeout(setUnchanged, 100)
        populate_stdout()
    })
}

function populate_function_list() {
    get('/function_list', function(replica_counts) {
        let ul = document.getElementById('function_list');
        let html = '';
        arr = []
        procs = []
        for (var name in replica_counts) {
            if (name.startsWith('process:')) {
              process = true
              procs.push([name, replica_counts[name]])
            } else {
              arr.push([name, replica_counts[name]])
              process = false
            }
        }
        arr = arr.concat(procs)
        for (var o of arr) {
            var name = o[0]
            var c = o[1]
            classes = []
            if (name == window.fname) classes.push('active')
            if (!name.startsWith('process:') && c == 0) classes.push('broken')
            if (name.startsWith('process:')) {
                classes.push('process')
                name = name.replace("process:", "")
            }
            html += '<li '
            if (classes.length > 0) {
                html += 'class="' + classes.join(' ') + '"'
            }
            html += '>' + name + '</li>';
        }
        ul.innerHTML = html;
        for (var li of ul.getElementsByTagName('li')) {
            li.onclick = (function(_fname) {
                return function() { open_file(getProperName(_fname)); populate_function_list(); }
            })(li.innerText)
        }
    })
}

function populate_stdout() {
    if (!window.fname) return
    if (getProperName(window.fname).startsWith('process:')) return
    get('/stdout/' + getProperName(window.fname), function(d) {
        var o = document.getElementById('stdout')
        var oo = ""
        for (var i=d['stdouts'].length-1; i>=0; i--) {
          t = (new Date(d['stdouts'][i]['tstamp']*1000)).toISOString().replace("T"," ").slice(0,19)
          oo += t + ' >> ' + d['stdouts'][i]['stdout'].trim().replaceAll("\n", "\n" + t + ' >> ') + "\n"
        }
        o.innerText = oo
    })
}

function intervolate(fn, ms) { var i=setInterval(fn, ms); fn(); console.log(i); return i;}

intervolate(populate_function_list, 2000)
intervolate(populate_stdout, 10000)
intervolate(function() {
  get('/read/' + getProperName(window.fname), function(j) {});  
}, 60*1000) // update the timestamp so the stdout logger keeps running

document.getElementById('new_function').onclick = function() {
    var new_fname = prompt("choose a dang filename")
    if (!new_fname) return
    window.fname = new_fname
    post('/create/' + window.fname)
    populate_function_list()
}

document.getElementById('delete_function').onclick = function() {
    var fname = prompt("!!! give the function name you want to delete !!!")
    if (!fname) return
    if (window.fname == fname) {
        window.fname = ''
    }
    open_file(window.fname)
    post('/delete/' + fname)
    populate_function_list()
}

document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        post('/write/' + getProperName(window.fname), {'code':flask.getCode()})
        setUnchanged()
    }
});
</script>
