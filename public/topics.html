<title>DFaaS</title>

<script src="codeflask.min.js"></script>

<style type="text/css">

pre .token.keyword:visible {
    background: white;
}


 code[class*="language-"], pre[class*="language-"] {
 /*
     font-family: Consolas, Menlo, Monaco, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", "Courier New", Courier, monospace;
 */
     font-size: 13px;
     line-height: 20px;
     direction: ltr;
     text-align: left;
     white-space: pre;
     word-spacing: normal;
     word-break: normal;
     -moz-tab-size: 4;
     -o-tab-size: 4;
     tab-size: 4;
     -webkit-hyphens: none;
     -moz-hyphens: none;
     -ms-hyphens: none;
     hyphens: none;
     /* background: #14110b; */
     color: #aaaaff;
}
 pre > code[class*="language-"] {
     font-size: 1em;
}
 pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection, code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
     text-shadow: none;
     background: #6f5849;
     caret-color: red;
}
 pre[class*="language-"]::selection, pre[class*="language-"] ::selection, code[class*="language-"]::selection, code[class*="language-"] ::selection {
     text-shadow: none;
     background: #6f5849;
}
/* Code blocks */
 pre[class*="language-"] {
     overflow: auto;
}
/* Inline code */
 :not(pre) > code[class*="language-"] {
     padding: .1em;
     border-radius: .3em;
}
 .token.comment, .token.prolog, .token.doctype, .token.cdata {
     color: #666688;
}
 .token.punctuation {
     color: #cc4499;
}
 .token.namespace {
     opacity: .7;
}
 .token.tag, .token.operator, .token.number {
     color: #bfa05a;
}
 .token.property, .token.function {
     color: #ffcc33;
}
 .token.tag-id, .token.selector, .token.atrule-id {
     color: #fff3eb;
}
 code.language-javascript, .token.attr-name {
     color: #a48774;
}
.token.boolean { color: #ff2200; } 
.token.string { color: #ffaa90; } 
.token.entity { color: #33cc99; } 
.token.url { color: #33cc99; } 
.token.function { color: #7788fff; } 
.language-css .token.string { color: #33cc99; } 
.language-scss .token.string { color: #33cc99; } 
.style .token.string { color: #33cc99; } 
.token.attr-value { color: #33cc99; } 
.token.keyword { color: #7788ff; } 
.token.control { color: #88ccff; } 
.token.directive { color: #33cc99; } 
.token.unit { color: #33cc99; } 
.token.statement { color: #33cc99; } 
.token.regex { color: #33cc99; } 
.token.atrule { color: #33cc99; } 
 .token.placeholder, .token.variable {
     color: #33cc99;
}
 .token.deleted {
     text-decoration: line-through;
}
 .token.inserted {
     border-bottom: 1px dotted #fff3eb;
     text-decoration: none;
}
 .token.italic {
     font-style: italic;
}
 .token.important, .token.bold {
     font-weight: bold;
}
 .token.important {
     color: #a48774;
}
 .token.entity {
     cursor: help;
}
 pre > code.highlight {
     outline: .4em solid #816d5f;
     outline-offset: .4em;
}
/* overrides color-values for the Line Numbers plugin * http://prismjs.com/plugins/line-numbers/ */
 .line-numbers.line-numbers .line-numbers-rows {
     border-right-color: #35302b;
}
 .line-numbers .line-numbers-rows > span:before {
     color: #46403d;
}
/* overrides color-values for the Line Highlight plugin * http://prismjs.com/plugins/line-highlight/ */
 .line-highlight.line-highlight {
     background: rgba(191, 160, 90, 0.2);
     background: -webkit-linear-gradient(left, rgba(191, 160, 90, 0.2) 70%, rgba(191, 160, 90, 0));
     background: linear-gradient(to right, rgba(191, 160, 90, 0.2) 70%, rgba(191, 160, 90, 0));
}
</style>

<style>
body {
    font-family: arial;
    margin: 0;
    padding: 0;
/*
    background: #14110b;
*/
}
body.not_electron {
    background: #14110b;
}
#background {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 20px 0 20px 20px;
    background: #14110b;
    z-index: -1;
    margin: 0;
    padding: 0;
}
#function_code {
    background: #14110b;
    margin-left: 150px;
}
.function_list_container {
    font-family: monospace;
    position: absolute;
    top: 0;
    left: 0;
    width: 150px;
    color: #ffcc33;
    height: 100%;
    overflow: scroll;
    user-select: none;
}
.function_list_container::-webkit-scrollbar {
    width: 0 !important
}
.function_list_container #new_function:hover {
    content: '‚ìß';
}
#function_list {
    list-style: none;
    padding: 0;
    width: 150px;
    overflow: hidden;
    padding-top: 20px;
}
#function_list li {
    padding: 5px 10px;
    margin: 0;
    width: 150px;
}
#function_list li:hover {
    background: #eeddee33;
    cursor: pointer;
}
#function_list li.active {
    background: #eeccee44;
}
#function_list li.broken:before {
    content: '‚≠ï';
    margin-right: 3px;
}
#function_list li.process:before {
    content: 'üìç';
    margin-right: 3px;
}
#new_function {
    cursor: pointer;
}
#delete_function {
    cursor: pointer;
}
.function_list_container .actions {
    text-align: center;
    width: 100%;
    margin-top: 10px;
}
textarea.codeflask__textarea {
    caret-color: red;
    color: black;
    overflow: hidden;
    width: calc(100%-80px);
}
textarea.codeflask__textarea.changes {
    background: #14110b;
    color: black;
}
#function_code .codeflask__pre {
    width: calc(100% - 50px);
}
#function_code textarea.codeflask__textarea {
    width: calc(100% - 50px) !important;
}
.code_container .codeflask__lines {
    color: #666688;
    background-color: #344470;
    border-radius: 0 0 30px 0;
    width: 30px !important;
    padding-right: 8px;
    height: 10000000px;
    user-select: none;
}
.codeflask.codeflask--has-line-numbers:before {
    background-color: #14110b !important;
    background: #14110b !important;
    background: #3333;
}
.codeflask.codeflask--has-line-numbers::-webkit-scrollbar {
    width: 0 !important
}
#function_code .codeflask {
    overflow: auto;
    width: calc(100% - 160px) !important;
    height: calc(100% - 50px);
}
#stdout {
    position: fixed;
    z-index: 1;
    width: 100%;
    padding: 10px 5px 5px 5px;
    height: 145px;
    bottom: -30px;
    overflow: auto;
    color: #ffcc33;
}
#stdout::-webkit-scrollbar {
    width: 0 !important
}
.code_container {
}
.topswoop {
    height: 50px;
    width: calc(100% - 150px);
    background-color: #344470;
    margin-left: 150px;
    margin-right: -50px;
    border-radius: 50px 0 0 0;
    -webkit-app-region: drag;
}
.topswoop .button {
    display: inline-block;
    font-size: 13px;
    float: right;
    padding: 32px 42px 0 5px;
    height: 18px;
    border-left: 3px solid #14110b;
    font-weight: bold;
    width: 30px;
    user-select: none;
    -webkit-app-region: no-drag;
    cursor: pointer;
    text-decoration: none;
    color: black;
}
.topswoop .btn-blue { background: #7799dd; }
.topswoop .btn-red { background: #ff7744; }
.topswoop .btn-yellow { background: #ffcc33; }
.topswoop .btn-green { background: #99dd66; }
.topswoop_after {
    width: 20px;
    height: 20px;
    background: #344470;
    position: absolute;
    left: 180px;
    z-index: 3;
}
.topswoop_after p {
    height: 20px;
    width: 20px;
    border-radius: 25px 0 0 0;
    background: #14110b;
    margin: 0;
}
#_map {
    width: calc(100% - 270px);
    height: calc(100% - 200px);
    margin-left: 200px;
    z-index: 1005;
    position: absolute;
    display: block;
    padding: 10px;
    max-height: 80%;
    cursor: pointer;
    visibility: hidden;
}
#map { cursor: pointer; }
.topswoop #title {
    display: inline-block;
    color: #ffcc33;
    height: 100%;
    min-width: 250px;
    margin-left: 100px;
    background-color: #14110b;
    font-size: 25px;
    padding: 9px 30px 0 30px;
    text-transform: uppercase;
    text-align: left;
    user-select: none;
    -webkit-app-region: drag;
    -webkit-user-select: none;
}

#new_dialog {
    position: absolute;
    left: 40%;
    top: 40%;
    text-transform: uppercase;
    z-index: 5;
    padding: 10px 10px 10px 20px;
    background-color: #7799dd;
    border-radius: 30px;
    font-size: 15px;
    font-weight: bold;
    visibility: hidden;
}
#new_dialog input {
    padding: 10px;
    border: none;
    caret-color: red;
    color: #ffcc33;
    background: #14110b;
    border-radius: 20px;
    outline: none;
}
</style>

<audio id='click_sound' src='/asset/click.wav' volume="0.1"></audio>
<audio id='newfile_sound' src='/asset/new_file.mp3' volume="0.1"></audio>
<audio id='error_sound' src='/asset/error.mp3' volume="0.1"></audio>
<audio id='deletefile_sound' src='/asset/delete_file.mp3' volume="0.1"></audio>
<audio id='savefile_sound' src='/asset/save_file.mp3' volume="0.1"></audio>
<audio id='reboot_sound' src='/asset/reboot.mp3' volume="0.1"></audio>

<div id="background"></div>

<div class='topswoop'>
    <div id="title"></div>
    <a class='button btn-yellow' href='/'>FNS</a>
    <a class='button btn-red' href='/progress'>PROG</a>
    <a class='button btn-blue' href='/topics'>TOPICS</a>
    <div class='button btn-green' id="map">MAP</div>
</div>
<div class='topswoop_after'><p></p></div>
<div class='code_container'>
  <div id="function_code"></div>
</div>

<div id="new_dialog">
    <span>New function name</span>
    <input id="new_dialog_textbox" type=text />
</div>

<!-- <img id='_map' src="http://node1:3002/fn_map.svg?level=1"></iframe> -->
<img id='_map' src="http://node1:32330/fn_map.svg?level=1"></iframe>

<div class="function_list_container">
  <ul id="function_list"></ul>
</div>


<script type='text/javascript'>
var params = window.location.search.length == 0 ? {} : window.location.search.slice(1).split("&").reduce(function(a, v) { var t=v.split("="); a[t[0]]=t[1]; return a; }, {})

if (navigator.userAgent.indexOf('Electron') == -1) {
    document.body.classList.add('not_electron')
}

Prism.languages.python = {
	'comment': {
		pattern: /(^|[^\\])#.*/,
		lookbehind: true,
		greedy: true
	},
	'string-interpolation': {
		pattern: /(?:f|fr|rf)(?:("""|''')[\s\S]*?\1|("|')(?:\\.|(?!\2)[^\\\r\n])*\2)/i,
		greedy: true,
		inside: {
			'interpolation': {
				// "{" <expression> <optional "!s", "!r", or "!a"> <optional ":" format specifier> "}"
				pattern: /((?:^|[^{])(?:\{\{)*)\{(?!\{)(?:[^{}]|\{(?!\{)(?:[^{}]|\{(?!\{)(?:[^{}])+\})+\})+\}/,
				lookbehind: true,
				inside: {
					'format-spec': {
						pattern: /(:)[^:(){}]+(?=\}$)/,
						lookbehind: true
					},
					'conversion-option': {
						pattern: /![sra](?=[:}]$)/,
						alias: 'punctuation'
					},
					rest: null
				}
			},
			'string': /[\s\S]+/
		}
	},
	'triple-quoted-string': {
		pattern: /(?:[rub]|br|rb)?("""|''')[\s\S]*?\1/i,
		greedy: true,
		alias: 'string'
	},
	'string': {
		pattern: /(?:[rub]|br|rb)?("|')(?:\\.|(?!\1)[^\\\r\n])*\1/i,
		greedy: true
	},
	'function': {
		pattern: /((?:^|\s)def[ \t]+)[a-zA-Z_]\w*(?=\s*\()/g,
		lookbehind: true
	},
	'class-name': {
		pattern: /(\bclass\s+)\w+/i,
		lookbehind: true
	},
	'decorator': {
		pattern: /(^[\t ]*)@\w+(?:\.\w+)*/m,
		lookbehind: true,
		alias: ['annotation', 'punctuation'],
		inside: {
			'punctuation': /\./
		}
	},
	'keyword': /\b(?:_(?=\s*:)|and|as|assert|async|await|class|def|del|exec|finally|from|global|import|in|is|lambda|match|nonlocal|not|or|print|return|with)\b/,
	'control': /\b(?:_(?=\s*:)|break|continue|if|elif|else|for|while|yield|try|except|raise|pass|case)\b/,
	'builtin': /\b(?:__import__|abs|all|any|apply|ascii|basestring|bin|bool|buffer|bytearray|bytes|callable|chr|classmethod|cmp|coerce|compile|complex|delattr|dict|dir|divmod|enumerate|eval|execfile|file|filter|float|format|frozenset|getattr|globals|hasattr|hash|help|hex|id|input|int|intern|isinstance|issubclass|iter|len|list|locals|long|map|max|memoryview|min|next|object|oct|open|ord|pow|property|range|raw_input|reduce|reload|repr|reversed|round|set|setattr|slice|sorted|staticmethod|str|sum|super|tuple|type|unichr|unicode|vars|xrange|zip)\b/,
	'boolean': /\b(?:False|None|True)\b/,
	'number': /\b0(?:b(?:_?[01])+|o(?:_?[0-7])+|x(?:_?[a-f0-9])+)\b|(?:\b\d+(?:_\d+)*(?:\.(?:\d+(?:_\d+)*)?)?|\B\.\d+(?:_\d+)*)(?:e[+-]?\d+(?:_\d+)*)?j?(?!\w)/i,
	'operator': /[-+%=]=?|!=|:=|\*\*?=?|\/\/?=?|<[<=>]?|>[=>]?|[&|^~]/,
	'punctuation': /[{}[\];(),.:]/,
    'misc': {
        pattern: /.+/,
        lookbehind: false
    }
};

Prism.languages.python['string-interpolation'].inside['interpolation'].inside.rest = Prism.languages.python;

Prism.languages.py = Prism.languages.python;


click_sound.volume = 0.15
newfile_sound.volume = 0.15
error_sound.volume = 0.15
deletefile_sound.volume = 0.15
savefile_sound.volume = 0.15
reboot_sound.volume = 0.15

const flask = new CodeFlask('#function_code', {
  language: 'py',
  lineNumbers: true,
  handleTabs: true,
  defaultTheme: false
});

function setChanged() {
    flask.elWrapper.getElementsByTagName('textarea')[0].classList.add('changes')
}
function setUnchanged() {
    flask.elWrapper.getElementsByTagName('textarea')[0].classList.remove('changes')
}

flask.onUpdate(setChanged)

window['flask'] = flask;

window.fname = params['fname'] || ''
window.process = fname.startsWith('process:')
window.changed = false

function get(url, fn) {
    var x = new XMLHttpRequest();
    x.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            fn(JSON.parse(x.responseText))
        }
    }
    x.open('GET', url, true);
    x.send();
}
function post(url, json, fn) {
    var x = new XMLHttpRequest();
    x.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            fn && fn(JSON.parse(x.responseText))
        }
    }
    x.open('POST', url, true);
    x.setRequestHeader('Content-Type', 'application/json');
    x.send(JSON.stringify(json));
}

function getProperName(_fname) {
    var _procs = document.getElementById('function_list').getElementsByClassName('process')
    for (var proc of _procs) {
      if (_fname == proc.innerText) {
        return 'process:' + _fname;
      }
    }
    return _fname
}

function open_file(_fname) {
    window.fname = getProperName(_fname);
    document.getElementById('title').innerHTML = _fname;
    params['fname'] = _fname
    process =  _fname.startsWith('process:')
    var newsearch = '?' + Object.keys(params).map(function(v) { return v + "=" + params[v]; }).join("&")
    window.history.pushState(null, null, newsearch)
    get('/stdout/:' + _fname + "?time=20", function(d) {
        var oo = ""
        for (var i=0; i < d['stdouts'].length-1; i++) {
            if ('tstamp' in d['stdouts'][i]) {
                t = d['stdouts'][i]['tstamp'].slice(0,19)
                delete d['stdouts'][i]['tstamp']
            } else {
                t = ""
            }
            oo += t + ' >> ' + JSON.stringify(d['stdouts'][i]).replaceAll("\n", "\n" + t + ' >> ') + "\n"
        }
        flask.updateCode(oo)
    })
    //click_sound.play()
}
setInterval(function() { open_file(window.fname); }, 5000)

function populate_function_list() {
    get('/topic_list', function(replica_counts) {
        let ul = document.getElementById('function_list');
        let html = '';
        arr = []
        procs = []
        var process
        for (var name in replica_counts) {
            if (name.startsWith('process:')) {
              process = true
              procs.push([name, replica_counts[name]])
            } else {
              arr.push([name, replica_counts[name]])
              process = false
            }
        }
        arr = arr.concat(procs)
        for (var o of arr) {
            var name = o[0]
            var c = o[1]
            classes = []
            if (name == window.fname) classes.push('active')
            if (!name.startsWith('process:') && c == 0) classes.push('broken')
            if (name.startsWith('process:')) {
                classes.push('process')
                name = name.replace("process:", "")
            }
            html += '<li '
            if (classes.length > 0) {
                html += 'class="' + classes.join(' ') + '"'
            }
            html += '>' + name + '</li>';
        }
        ul.innerHTML = html;
        for (var li of ul.getElementsByTagName('li')) {
            li.onclick = (function(_fname) {
                return function() { open_file(getProperName(_fname)); populate_function_list(); }
            })(li.innerText)
        }
    })
}

function intervolate(fn, ms) { var i=setInterval(fn, ms); fn(); return i;}

intervolate(populate_function_list, 2000)

document.getElementById('new_dialog_textbox').onkeydown = function() {
    if (event.keyCode == 27) {
        document.getElementById('new_dialog').style.visibility = 'hidden'
        document.getElementById('new_dialog_textbox').value = ''
    }
    if (event.keyCode != 13) return;
    var new_fname = document.getElementById('new_dialog_textbox').value
    if (new_fname == "") {
        error_sound.play()
        return
    }
    window.fname = new_fname
    document.getElementById('new_dialog').style.visibility = 'hidden';
    document.getElementById('new_dialog_textbox').value = ''
    post('/create/' + window.fname)
    setTimeout(function() {
      populate_function_list()
      open_file(window.fname)
    }, 20);
    newfile_sound.play()
}

document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        if (process) {
            document.getElementById('stdout').innerHTML = ''
        }
        post('/write/' + getProperName(window.fname), {'code':flask.getCode()}, function(d) {
            if (d.stdout) document.getElementById('stdout').innerHTML = d.stdout
            savefile_sound.play()
        })
        setUnchanged()
    }
});

document.getElementById('map').onclick = function() {
    var m = document.getElementById('_map')
    var splot = m.style.visibility == 'visible' ? 'hidden' : 'visible'
    var splet = m.style.visibility == 'visible' ? 'visible' : 'hidden'
    m.style.visibility = splot
    document.getElementsByClassName('codeflask__pre')[0].style.visibility = splet
    document.getElementsByClassName('codeflask__textarea')[0].style.visibility = splet
    click_sound.play()
}
document.getElementById('_map').onclick = function() {
    click_sound.play()
    var m = document.getElementById('_map')
    var i = parseInt(m.src.split("?")[1].split("level=")[1].split("&")[0]);
    i = (i + 1) % 2;
    m.src = "/fn_map.svg?level=" + i + "&cachebust=" + (new Date()).getTime()
}

function hideOverflowItems(container_selector, elements_selector) {
    var container = document.querySelector(container_selector)
    var cc = container.getBoundingClientRect()
    for (var el of document.querySelectorAll(elements_selector)) {
        el.style.visibility = (el.getBoundingClientRect().bottom > cc.bottom) ? 'hidden' : 'visible'
    }
}

document.addEventListener('scroll', function() {
    hideOverflowItems('#function_code .codeflask', '#function_code .codeflask pre span');
    hideOverflowItems('.function_list_container', '.function_list_container li');
}, true)
window.onresize = function() {
    hideOverflowItems('#function_code .codeflask', '#function_code .codeflask pre span');
    hideOverflowItems('.function_list_container', '.function_list_container li');
}

if (fname != '') {
  open_file(fname)
}
</script>
